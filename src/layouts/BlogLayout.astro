---
import Section from "../components/common/Section.astro";
import type { ArticleFrontmatter } from "../lib/types";
import {
  getShortDescription,
  processArticleDate,
  generateSourceUrl,
  autoGenerateArticleFields,
} from "../lib/utils";
import { GLOBAL } from "../lib/variables";
import type { MarkdownLayoutProps } from "astro";
import Prose from "../components/Prose.astro";
import Layout from "./Layout.astro";

type Props = MarkdownLayoutProps<ArticleFrontmatter>;

const { frontmatter, rawContent, file } = Astro.props;

// Auto-generate missing fields with intelligent defaults
const autoGeneratedFrontmatter = autoGenerateArticleFields(
  frontmatter,
  file,
  () => rawContent()
);

// Derived values
const shortDescription = getShortDescription(
  autoGeneratedFrontmatter.description || ""
);
const articleDate = processArticleDate(
  autoGeneratedFrontmatter.timestamp || ""
);
const sourceUrl = generateSourceUrl(
  autoGeneratedFrontmatter.filename || "",
  "blog"
);
const isPublished = autoGeneratedFrontmatter.published;
---

{
  !isPublished ? (
    <Layout>
      <Section class="mt-16">
        <h1 class="text-3xl sm:text-4xl font-display pb-8">
          Well, this is awkward
        </h1>
        <h2 class="text-xl sm:text-2xl pb-8">404 - Page not found</h2>
        <p>
          You found an article that is not yet published, maybe you were
          snooping around my GitHub? If you want to return to safety,{" "}
          <a class="underline underline-offset-4 font-medium" href="/">
            click here to go home.
          </a>
        </p>
      </Section>
    </Layout>
  ) : (
    <Layout>
      <Fragment slot="head">
        <title>
          {autoGeneratedFrontmatter.title} • {GLOBAL.username}
        </title>
        <meta
          name="description"
          content={autoGeneratedFrontmatter.description}
        />
        <meta
          property="og:title"
          content={`${autoGeneratedFrontmatter.title} • ${GLOBAL.username}`}
        />
        <meta property="og:description" content={shortDescription} />
        <meta
          property="og:image"
          content={`${GLOBAL.rootUrl}/${GLOBAL.profileImage}`}
        />
        <meta property="og:url" content={autoGeneratedFrontmatter.url} />
        <meta name="twitter:card" content="summary_large_image" />
        <meta
          name="twitter:title"
          content={`${autoGeneratedFrontmatter.title} • ${GLOBAL.username}`}
        />
        <meta name="twitter:description" content={shortDescription} />
        <meta
          name="twitter:image"
          content={`${GLOBAL.rootUrl}/${GLOBAL.profileImage}`}
        />
        <meta http-equiv="content-language" content="en" />
        <meta name="language" content="English" />
        <link rel="canonical" href={sourceUrl} />
      </Fragment>

      <article class="py-16">
        <div class="max-w-4xl mx-auto px-4">
          <!-- Article header with metadata cluster -->
          <header class="mb-16 relative">
            <!-- Floating metadata labels -->
            <div class="flex flex-wrap gap-4 mb-6 text-xs uppercase tracking-wider opacity-60">
              <span class="border-brutal-thin px-3 py-1">{articleDate}</span>
              <span class="border-brutal-thin px-3 py-1 bg-sage text-white">{autoGeneratedFrontmatter.time || 5} min read</span>
            </div>

            <!-- Title -->
            <h1 class="text-4xl md:text-6xl font-bold leading-tight mb-6 max-w-3xl">
              {autoGeneratedFrontmatter.title}
            </h1>

            <!-- Description with accent -->
            <div class="relative inline-block max-w-2xl">
              <p class="text-lg md:text-xl leading-relaxed relative z-10 py-2">
                {autoGeneratedFrontmatter.description}
              </p>
              <div class="absolute bottom-0 left-0 w-full h-3 bg-sage opacity-30 -z-10"></div>
            </div>

            <!-- Decorative line break -->
            <div class="mt-12 border-t-brutal w-full"></div>
          </header>

          <!-- Article content -->
          <Prose>
            <slot />
          </Prose>
        </div>
      </article>
    </Layout>
  )
}
